#include "Adafruit_seesaw.h"
#include <Wire.h>
#include <Adafruit_VL53L0X.h>

// Create sensor instances
Adafruit_seesaw ss;
Adafruit_VL53L0X lox = Adafruit_VL53L0X();

// Constants
const int MOISTURE_THRESHOLD = 740;  
const int TEMP_THRESHOLD = 30;       
const int THRESHOLD = 500;           
const float DEBOUNCE_TIME = 0.2;    
const int SPEED_THRESHOLD = 30;     
const float BLADE_RADIUS = 5.0;  

// Variables
unsigned long previousTime = 0;  
unsigned long lastReadTime = 0;  
bool seesawAvailable = false;
bool vl53l0xAvailable = false;

void setup() {
  Serial.begin(115200);
  
  // Initialize Seesaw (Moisture + Temp Sensor)
  if (!ss.begin(0x36)) {
    Serial.println("ERROR! seesaw not found. Continuing without it.");
  } else {
    Serial.println("seesaw started!");
    seesawAvailable = true;
  }

  // Initialize VL53L0X Distance Sensor
  Wire.begin();
  if (!lox.begin()) {
    Serial.println("Failed to initialize VL53L0X sensor! Running without it.");
  } else {
    vl53l0xAvailable = true;
  }

  Serial.println("Measuring Wind Turbine Speed...");
}

void loop() {
  // Non-blocking timer for loop execution (every 50ms)
  if (millis() - lastReadTime < 50) return;  
  lastReadTime = millis();

  int conditionCount = 0;  

  // Read moisture & temperature if Seesaw sensor is available
  float temp = 0;
  uint16_t touch = 0;
  if (seesawAvailable) {
    temp = ss.getTemp();
    touch = ss.touchRead(0);

    Serial.print("Temperature: ");
    Serial.print(temp);
    Serial.println(" *C");

    Serial.print("Capacitive: ");
    Serial.println(touch);

    if (touch <= MOISTURE_THRESHOLD) {
      Serial.println("Moisture condition met: Dry soil");
      conditionCount++;
    }

    if (temp >= TEMP_THRESHOLD) {
      Serial.println("Temperature condition met: Hot");
      conditionCount++;
    }
  }

  // Read distance & calculate speed if VL53L0X is available
  if (vl53l0xAvailable) {
    uint16_t distance = lox.readRange();
    
    if (lox.timeoutOccurred()) {
      Serial.println("VL53L0X timeout occurred.");
    } else if (distance < THRESHOLD) {
      unsigned long currentTime = millis();  

      if (previousTime != 0) {
        unsigned long deltaTime = currentTime - previousTime;

        if (deltaTime > DEBOUNCE_TIME * 1000) {
          float rpm = 60000.0 / deltaTime;
          float circumference = 2 * 3.14159 * BLADE_RADIUS;  
          float circumferenceInKm = circumference / 1000.0;  
          float speedKmPerHr = rpm * circumferenceInKm * 60.0;

          Serial.print("Blade Speed: ");
          Serial.print(speedKmPerHr, 2);
          Serial.println(" km/h");

          if (speedKmPerHr >= SPEED_THRESHOLD) {
            Serial.println("Wind speed condition met: Strong winds");
            conditionCount++;
          }

          previousTime = currentTime;
        }
      } else {
        previousTime = currentTime;
      }
    }
  }

  Serial.print("Condition Count: ");
  Serial.println(conditionCount);
}
