#include "Adafruit_seesaw.h"
#include <Wire.h>
#include <Adafruit_VL53L0X.h>
#include <Servo.h>

// Initialize sensors & servo
Adafruit_seesaw ss;
Adafruit_VL53L0X lox = Adafruit_VL53L0X();
Servo myServo;

// Constants
const int MOISTURE_THRESHOLD = 740;
const int TEMP_THRESHOLD = 30;
const int THRESHOLD = 500;   // Blade detection distance (mm)
const float DEBOUNCE_TIME = 0.2;  // Avoid multiple detections (sec)
const float BLADE_RADIUS = 5.0;   // Blade radius in meters
const int SPEED_THRESHOLD = 30;   // Wind speed threshold (km/h)

unsigned long previousTime = 0; 

void setup() {
    Serial.begin(115200);
    Wire.begin();

    // Initialize Seesaw
    if (!ss.begin(0x36)) {
        Serial.println("ERROR! Seesaw not found");
        while (1);
    }

    // Initialize VL53L0X
    if (!lox.begin()) {
        Serial.println("ERROR! VL53L0X not found");
        while (1);
    }

    // Initialize Servo
    myServo.attach(9);
    myServo.write(0);  // Full speed clockwise

    Serial.println("timestamp,temperature_C,moisture,blade_rpm,wind_speed_kmh");
}

void loop() {
    unsigned long timestamp = millis();
    float temp = ss.getTemp();
    uint16_t moisture = ss.touchRead(0);
    uint16_t distance = lox.readRange();
    float rpm = 0, wind_speed = 0;

    // Detect blade movement
    if (distance < THRESHOLD) {
        unsigned long currentTime = millis();
        if (previousTime != 0 && (currentTime - previousTime) > (DEBOUNCE_TIME * 1000)) {
            rpm = 60000.0 / (currentTime - previousTime);
            float circumference_km = (2 * 3.14159 * BLADE_RADIUS) / 1000.0;
            wind_speed = rpm * circumference_km * 60.0;
            previousTime = currentTime;
        }
    }

    // Print formatted data for InfluxDB
    Serial.print(timestamp);
    Serial.print(",");
    Serial.print(temp, 2);
    Serial.print(",");
    Serial.print(moisture);
    Serial.print(",");
    Serial.print(rpm, 2);
    Serial.print(",");
    Serial.println(wind_speed, 2);

    delay(1000);  // Send data every second
}
